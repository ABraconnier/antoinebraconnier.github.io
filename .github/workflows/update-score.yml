name: update-high-score
on:
  repository_dispatch:
    types: [update-score]
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Update score in YAML
        env:
          SCORE: ${{ github.event.client_payload.score }}
          PLAYER: ${{ github.event.client_payload.player }}
          TIMESTAMP: ${{ github.event.client_payload.timestamp }}
        run: |
          # Use yq to safely write YAML (avoids injection)
          # Environment variables are safely passed and properly escaped
          yq eval -n \
            '.chantalpanic.score = env(SCORE) |
             .chantalpanic.name = env(PLAYER) |
             .chantalpanic.timestamp = env(TIMESTAMP)' \
            > _data/best_scores.yml
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _data/best_scores.yml

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸŽ® Update high score: ${{ github.event.client_payload.score }} by ${{ github.event.client_payload.player }}"
            git push
          fi
